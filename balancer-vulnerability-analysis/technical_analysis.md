# Balancer V2 Stable Pool Vulnerability Technical Analysis Report

## Attack Mechanism Overview

The attacker precisely controls the input amount and exploits the downward rounding operations in Balancer stable pools to artificially lower the invariant D, thereby distorting the BPT price and extracting profit. This is a typical precision rounding attack and represents a protocol-level mechanism design flaw.

## Three-Stage Attack Flow

### Stage One: Boundary Condition Preparation
- Operation: Precisely adjust the cbETH balance to a rounding boundary value (amount = 9)
- Purpose: Create ideal mathematical conditions for the subsequent precision attack
- Technical implementation: Fine-tune the balance via initial swaps between BPT and underlying assets

### Stage Two: Precision Rounding Attack (Core Vulnerability)
- Operation: Execute a token swap using a specific amount (= 8)
- Key vulnerability: The `_downscaleDown` function performs downward rounding
- Mathematical impact:
  - The computed Œîy is systematically underestimated
  - The stable pool invariant D is artificially reduced
  - BPT price = D / totalSupply becomes distorted

### Stage Three: Profit from Price Distortion
- Operation: Perform reverse operations to buy back the BPT that was maliciously depressed in price
- Profit mechanism: Arbitrage using the distorted BPT price
- Funds flow: Value is extracted from the pool's other liquidity providers

## Vulnerability Call Chain Analysis

Attacker calls `batchSwap`  
‚Üì  
`ComposableStablePool._swapGivenIn` (line 187)  
‚Üì  
`BaseGeneralPool._swapGivenAt`  
‚Üì  
`_onSwapGivenIn` (`StableMath._calcOutGivenIn` @ line 124)  
‚Üì  
`_downscaleDown` (`BaseGeneralPool` @ line 65)  
‚Üì  
`_downscaleDown` (`ScalingHelpers.sol` @ line 77) ‚Üê üéØ Core of the vulnerability!  
‚Üì  
`FixedPoint.divDown` @ lines 47/82 ‚Üê üí• Root cause: downward rounding operation  
‚Üì  
Returns the maliciously rounded result

## Key Code Locations

### Attack Entry Point

File: `pkg/pool-stable/contracts/ComposableStablePool.sol` (line 187)
```solidity
function _swapGivenIn(
    SwapRequest memory swapRequest,
    uint256[] memory registeredBalances,
    uint256 registeredIndexIn,
    uint256 registeredIndexOut,
    uint256[] memory scalingFactors
) internal virtual override returns (uint256) {
    // Ultimately calls _downscaleDown, passing the computed amount
    return _downscaleDown(amountCalculated, scalingFactors[registeredIndexOut]);
}
```

### Core Mathematical Computation

File: `pkg/pool-stable/contracts/StableMath.sol` (line 124)

`_calcOutGivenIn()`: Core function that computes swap outputs, based on the StableSwap mathematical model

### Vulnerability Propagation Chain
- `BaseGeneralPool.sol` (line 65): calls the `_downscaleDown` function
- `ScalingHelpers.sol` (line 77): implements `_downscaleDown` logic
- `ScalingHelpers.sol` (lines 47/82): calls `FixedPoint.divDown` to perform downward rounding

### Root Cause of the Vulnerability

In `pkg/solidity-utils/contracts/helpers/ScalingHelpers.sol`:
```solidity
function _downscaleDown(uint256 amount, uint256 scalingFactor) 
    pure returns (uint256) {
    return FixedPoint.divDown(amount, scalingFactor); // Critical vulnerability point!
}
```

#### Root Cause Analysis
- Downward rounding: `FixedPoint.divDown` performs downward rounding rather than rounding to nearest
- Boundary exploitation: Attackers trigger maximal rounding effects at specific numerical boundaries (e.g., 8‚Üí9)
- Systematic bias: Rounding error is amplified in complex mathematical computations, allowing malicious manipulation of the invariant D
- Price distortion: BPT price depends directly on D, creating the full attack chain

## Scope of Impact

| Impact Type | Description |
|-------------|-------------|
| Direct Impact | BPT price of the stable pool is maliciously distorted |
| Indirect Impact | All derivative protocols depending on that pool's price are affected |
| Systemic Risk | Exposes protocol dependency risks in DeFi composability |