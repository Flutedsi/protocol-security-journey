# Balancer V2 稳定池漏洞技术分析报告

## 攻击机制概述

攻击者通过精确控制输入数量，利用 Balancer 稳定池中的**向下舍入操作**，人为压低不变式 D 值，从而扭曲 BPT 价格并获利。这是一种典型的**精度舍入攻击**，属于协议层机制设计漏洞。

## 三阶段攻击流程

### 阶段一：边界条件准备
- **操作**：将 cbETH 余额精确调整至舍入边界值（数量 = 9）
- **目的**：为后续精度攻击创造理想的数学条件
- **技术实现**：通过 BPT 与基础资产的初始交换实现余额微调

### 阶段二：精度舍入攻击（核心漏洞）
- **操作**：使用特定数量（=8）执行代币交换
- **关键漏洞**：`_downscaleDown` 函数执行向下舍入
- **数学影响**：
  - 计算出的 Δy 被系统性低估
  - 稳定池不变式 D 被人为压降
  - BPT 价格 = D / totalSupply 随之扭曲

### 阶段三：价格扭曲获利
- **操作**：反向操作买回被恶意压价的 BPT
- **获利机制**：利用被扭曲的 BPT 价格进行套利
- **资金流向**：从池子其他流动性提供者处抽取价值

## 漏洞调用链分析

攻击者调用 `batchSwap`  
↓  
`ComposableStablePool._swapGivenIn` (187 行)  
↓  
`BaseGeneralPool._swapGivenAt`  
↓  
`_onSwapGivenIn` (`StableMath._calcOutGivenIn` @ 124 行)  
↓  
`_downscaleDown` (`BaseGeneralPool` @ 65 行)  
↓  
`_downscaleDown` (`ScalingHelpers.sol` @ 77 行) ← 🎯 漏洞核心！  
↓  
`FixedPoint.divDown` @ 47/82 行 ← 💥 根本原因：向下舍入操作  
↓  
返回被恶意舍入的结果

## 关键代码定位

### 攻击入口点

**文件**: `pkg/pool-stable/contracts/ComposableStablePool.sol` (187 行)
```solidity
function _swapGivenIn(
    SwapRequest memory swapRequest,
    uint256[] memory registeredBalances,
    uint256 registeredIndexIn,
    uint256 registeredIndexOut,
    uint256[] memory scalingFactors
) internal virtual override returns (uint256) {
    // 最终调用 _downscaleDown，传入计算后的金额
    return _downscaleDown(amountCalculated, scalingFactors[registeredIndexOut]);
}
```

### 数学计算核心

**文件**: `pkg/pool-stable/contracts/StableMath.sol` (124 行)

`_calcOutGivenIn()`: 计算交换输出的核心函数，基于 StableSwap 数学模型

### 漏洞传播链
- `BaseGeneralPool.sol` (65 行): 调用 `_downscaleDown` 函数
- `ScalingHelpers.sol` (77 行): 实现 `_downscaleDown` 逻辑
- `ScalingHelpers.sol` (47/82 行): 调用 `FixedPoint.divDown` 执行向下舍入

### 漏洞根本原因

在 `pkg/solidity-utils/contracts/helpers/ScalingHelpers.sol` 中：
```solidity
function _downscaleDown(uint256 amount, uint256 scalingFactor) 
    pure returns (uint256) {
    return FixedPoint.divDown(amount, scalingFactor); // 关键漏洞点！
}
```

#### 根本原因分析
- **向下舍入操作**：`FixedPoint.divDown` 执行向下舍入，而非四舍五入
- **边界条件利用**：攻击者在特定数值边界（如 8→9）触发最大舍入效应
- **系统性偏差**：舍入误差在复杂数学计算中被放大，导致不变式 D 被恶意操控
- **价格扭曲**：BPT 价格直接依赖不变式 D，形成完整的攻击链条

## 攻击影响范围

| 影响类型 | 描述 |
|----------|------|
| **直接影响** | 稳定池的 BPT 价格被恶意扭曲 |
| **间接影响** | 所有依赖该池子价格的衍生协议受到影响 |
| **系统性风险** | 暴露了 DeFi 乐高组合中的协议依赖风险 |